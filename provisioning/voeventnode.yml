- hosts: voeventnode
  roles:
    - role: swapfile
      sudo: yes
  vars:
    voevent_users:
      - voeventdeploy
      - voeventserve

  tasks:
    - include: tasks/base.yml
    - include: tasks/users.yml

    - name: Get apt-packages required for installing comet.
      apt: update_cache=yes cache_valid_time=600 name={{item}}
      with_items:
        - libxml2-dev
        - libxslt1-dev
        - zlib1g-dev
      sudo: yes

    - name: Install comet into a virtualenv
      remote_user: voeventdeploy
      pip:
        name: "{{item}}"
        virtualenv: /home/voeventdeploy/deploy_venv
      with_items:
        cython comet

    - name: Upload Comet invocation command
      copy:
        src: files/invoke-comet.sh
        dest: /home/voeventdeploy/invoke-comet.sh
        owner: voeventdeploy
        group: voevent
        mode: "u=rwx,g=rx,o=rx"
      remote_user: voeventdeploy
      #Restart service if invocation has changed:
      notify:
        - restart voeventnode

    - name: Upload Comet init script
      copy:
        src: files/init/voeventnode.conf
        dest: /etc/init/voeventnode.conf
        owner: root
        group: root
        mode: "u=rw,g=r,o=r"
      sudo: yes
      #Restart service if init-script has changed:
      notify:
        - restart voeventnode

    - name: Start the 'voeventnode' service
      service: name=voeventnode state=started
      sudo: yes

  handlers:
    - name: restart voeventnode
      service: name=voeventnode state=restarted
      sudo: yes